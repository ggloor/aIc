---
title: "aIc: am I compositional?"
author: "Greg Gloor"
date: "`r format(Sys.time(), '%d %B, %Y')`"
package: aIc
abstract: >
  Document summary
output: 
  BiocStyle::html_document
vignette: >
  \VignetteIndexEntry{aIc: am I compositional?}
  \VignetteEngine{knitr::rmarkdown}
  \VignetteEncoding{UTF-8}  
---
  
# A simple test function to determine if the data are behaving as compositional data or are pathological in some other way.

The overall idea here is that pathologies in data have knock-on effects for analysis. 

The first pathology is a singular covariation matrix. A singular cov matrix means that approaches for analysis need to be interpreted properly.  

```{r, echo=F}

library(aIc)
library(matrixcalc)
library(edgeR)
library(ALDEx2)
data(selex)

```

There is no point testing for scale invariance or perturbation invariance \footnote{cause I said so}

secondarily test different standard transformations of the data to test for change in compositional behaviour

start with the selex dataset and then move on to Barton 

# sub-compositions and correlation (coherence)

The first idea is to test for correlation in a full dataset and a subset of the data and if different the data are compostions and need to be treated as such. This is a correlation coherence test. Correlations in compositional data are not stable to subsetting and any transformation that is not coherent should not be trusted to build correlation networks.

As a simple example, let's try the selex dataset with the clr transformation. Here the expected result is that the features are not sub-compostionally coherent under the test as shown by Lovell in 2015. 

In other words, correlations change as different filtering and pre-processing steps are performed on the data. If this happens in your data with your transformation do not use correlation, and use a compositionally appropriate measure of association. 

```{r, echo=T}

test.cor <- aIc.coherent(selex, group=group, norm.method='clr', log=F)
test.cor$is.coherent
plot(test.cor$plot, main=test.cor$main, xlab=test.cor$xlab, ylab=test.cor$ylab)

```
Thus, we see that under the clr, features in common between sub-compositions and the full composition display variable correlations. 

## sub-compositions and distance (dominance)

The second test is subcompositional dominance. That is, the subset should always have an equal or smaller difference between samples than the full (non-subsetted) dataset.


```{r, echo=T}

test.dom <- aIc.dominant(selex, group=group, norm.method='clr', log=F)
test.dom$is.dominant
plot(test.dom$plot, main=test.cor$main, xlab=test.dom$xlab, ylab=test.dom$ylab)

```

## testing for singular covariance matrix structure (singularity)

The third test is for a singular covariance matrix. Simple log-ratio transforms (eg. clr) have a singular covariance matrix and this needs to be acknowledged during any analysis and this changes how we deal with dimension reduction and exploratory data analysis. 

```{r, echo=T}

test.sin <- aIc.singular(selex, group=group, norm.method='clr')
test.sin$is.singular

```
